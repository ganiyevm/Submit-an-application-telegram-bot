
const TelegramBot = require('node-telegram-bot-api');
require('dotenv').config();

const token = process.env.TELEGRAM_BOT_TOKEN;
const bot = new TelegramBot(token, { polling: true });

let userLanguages = {};
let userPhoneNumbers = {};
let userNames = {};
let userLocations = {};
let userRequests = {}; // Foydalanuvchilar arizalarini saqlash uchun obyekt

// Foydalanuvchiga til tanlash tugmasi
const languageKeyboard = {
    reply_markup: {
        keyboard: [[
            'O\'zbekcha',
            '–†—É—Å—Å–∫–∏–π',
            'English',]
        ],
        resize_keyboard: true,
        one_time_keyboard: false,
    },
};

// Bot start qilinishi bilan foydalanuvchiga til tanlash taklif qilinadi
bot.onText(/\/start/, (msg) => {
    const chatId = msg.chat.id;
    const welcomeMessage = 'Iltimos, tilni tanlang / –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Choose language:';
    bot.sendMessage(chatId, welcomeMessage, languageKeyboard);
});

// Foydalanuvchi til tanlaydi
bot.on('message', (msg) => {
    const chatId = msg.chat.id;
    const text = msg.text;

    if (text === 'O\'zbekcha') {
        userLanguages[chatId] = 'uz';
        sendMainMenu(chatId, 'uz');
    } else if (text === '–†—É—Å—Å–∫–∏–π') {
        userLanguages[chatId] = 'ru';
        sendMainMenu(chatId, 'ru');
    } else if (text === 'English') {
        userLanguages[chatId] = 'en';
        sendMainMenu(chatId, 'en');
    } else if (userLanguages[chatId]) {
        handleMainMenuSelection(text, chatId, userLanguages[chatId]);
    }
});

// Asosiy menyu yuborish
function sendMainMenu(chatId, language) {
    const mainMenuKeyboard = {
        reply_markup: {
            keyboard: [
                [{ text: language === 'uz' ? 'Ariza qoldirish' : language === 'ru' ? '–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É' : 'Submit a request' }],
                [{ text: language === 'uz' ? 'Arizalarim' : language === 'ru' ? '–ú–æ–∏ –∑–∞—è–≤–∫–∏' : 'My requests' },
                 { text: language === 'uz' ? 'Tilni tanlash' : language === 'ru' ? '–í—ã–±–æ—Ä —è–∑—ã–∫–∞' : 'Choose language' }],
                [{ text: language === 'uz' ? 'Biz bilan bog\'lanish' : language === 'ru' ? '–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏' : 'Contact us' },
                 { text: language === 'uz' ? 'Bizning manzil' : language === 'ru' ? '–ù–∞—à –∞–¥—Ä–µ—Å' : 'Our address' }]
            ],
            resize_keyboard: true,
            one_time_keyboard: false,
        },
    };

    const mainMenuText = language === 'uz' ? 'Asosiy menyu:' :
                          language === 'ru' ? '–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:' :
                          'Main menu:';
    
    const description = language === 'uz' ?
        'Ushbu bot sizga kameralarni o\'rnatish uchun ariza qoldirishda yordam beradi.' :
        language === 'ru' ?
        '–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É –∫–∞–º–µ—Ä.' :
        'This bot will assist you in submitting a request for camera installation.';

    bot.sendMessage(chatId, `${mainMenuText}\n`, mainMenuKeyboard);
}

// Asosiy menyu tanlovlarini boshqarish
function handleMainMenuSelection(selection, chatId, language) {
    if (selection === (language === 'uz' ? 'Ariza qoldirish' : language === 'ru' ? '–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É' : 'Submit a request')) {
        const requestInstructions = language === 'uz' ? 
            'Ariza qoldirish uchun telefon raqamingizni kiriting: ' :
            language === 'ru' ? 
            '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏: ' :
            'Please enter your phone number to submit a request: ';

        const contactKeyboard = {
            reply_markup: {
                keyboard: [
                    [{
                        text: language === 'uz' ? 'Kontakt yuborish' : language === 'ru' ? '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç' : 'Send contact',
                        request_contact: true // Kontaktni so'raydi
                    }],
                    [{ text: language === 'uz' ? 'Menyuga qaytish' : language === 'ru' ? '–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é' : 'Return to menu' }]
                ],
                resize_keyboard: true,
                one_time_keyboard: false,
            },
        };

        bot.sendMessage(chatId, requestInstructions, contactKeyboard);
    } else if (selection === (language === 'uz' ? 'Arizalarim' : language === 'ru' ? '–ú–æ–∏ –∑–∞—è–≤–∫–∏' : 'My requests')) {
        const userRequestList = userRequests[chatId] || [];
        let responseMessage;
    
        if (userRequestList.length === 0) {
            responseMessage = language === 'uz' ? 'Sizda hech qanday ariza yo\'q.' :
                             language === 'ru' ? '–£ –≤–∞—Å –Ω–µ—Ç –∑–∞—è–≤–æ–∫.' :
                             'You have no requests.';
        } else {
            responseMessage = language === 'uz' ? 'Sizning arizalaringiz:' :
                              language === 'ru' ? '–í–∞—à–∏ –∑–∞—è–≤–∫–∏:' :
                              'Your requests:';
            
            userRequestList.forEach(request => {
                const requestStatus = request.status; // Ariza holatini oling
                const requestMessage = language === 'uz' ?
                    `\nID: ${request.id}, Ism: ${request.name}, Telefon: ${request.phone}, Holat: ${requestStatus}` :
                    language === 'ru' ?
                    `\nID: ${request.id}, –ò–º—è: ${request.name}, –¢–µ–ª–µ—Ñ–æ–Ω: ${request.phone}, –°—Ç–∞—Ç—É—Å: ${requestStatus}` :
                    `\nID: ${request.id}, Name: ${request.name}, Phone: ${request.phone}, Status: ${requestStatus}`;
                
                responseMessage += requestMessage; // Foydalanuvchi uchun xabarni qo'shing
            });
        }
    
        bot.sendMessage(chatId, responseMessage);
    
    } else if (selection === (language === 'uz' ? 'Tilni tanlash' : language === 'ru' ? '–í—ã–±–æ—Ä —è–∑—ã–∫–∞' : 'Choose language')) {
        bot.sendMessage(chatId, 'Iltimos, qulay tilni tanlang:', languageKeyboard);
    } else if (selection === (language === 'uz' ? 'Biz bilan bog\'lanish' : language === 'ru' ? '–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏' : 'Contact us')) {
        const contactInfo = language === 'uz' ? 
            `üìû Bizning telefon raqamimiz: +998997290030\nBizning telegram: @it_kaktus` :
            language === 'ru' ? 
            `üìû –ù–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: +998997290030\n–ù–∞—à Telegram: @it_kaktus` :
            `üìû Our phone number: +998997290030\nOur Telegram: @it_kaktus`;

        bot.sendMessage(chatId, contactInfo);
    } else if (selection === (language === 'uz' ? 'Bizning manzil' : language === 'ru' ? '–ù–∞—à –∞–¥—Ä–µ—Å' : 'Our address')) {
        const officeLocation = { latitude: 41.37149, longitude: 69.31241 };
        bot.sendLocation(chatId, officeLocation.latitude, officeLocation.longitude);
        const addressMessage = language === 'uz' ? 'üìç Yunusobod 19-44-47' :
                               language === 'ru' ? 'üìç –Æ–Ω—É—Å–∞–±–∞–¥ 19-44-47' :
                               'üìç Yunusabad 19-44-47';

        bot.sendMessage(chatId, addressMessage);
    } else if (selection === (language === 'uz' ? 'Menyuga qaytish' : language === 'ru' ? '–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é' : 'Return to menu')) {
        sendMainMenu(chatId, language); // Menyuga qaytish
    }
}

// Kontaktni qabul qilish
bot.on('contact', (msg) => {
    const chatId = msg.chat.id;
    const contact = msg.contact;

    if (contact) {
        userPhoneNumbers[chatId] = contact.phone_number;
        userNames[chatId] = msg.from.first_name || "No Name"; // Foydalanuvchining ismini olish

        // Manzil so'rash
        const requestLocationMessage = userLanguages[chatId] === 'uz' ?
            'Iltimos, manzilingizni yuboring:' :
            userLanguages[chatId] === 'ru' ?
            '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:' :
            'Please send your location:';

        const locationKeyboard = {
            reply_markup: {
                keyboard: [
                    [{
                        text: userLanguages[chatId] === 'uz' ? 'Yuborish' :
                              userLanguages[chatId] === 'ru' ? '–û—Ç–ø—Ä–∞–≤–∏—Ç—å' :
                              'Send',
                        request_location: true // Manzilni so'raydi
                    }],
                    [{
                        text: userLanguages[chatId] === 'uz' ? 'Menyuga qaytish' :
                              userLanguages[chatId] === 'ru' ? '–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é' :
                              'Return to menu'
                    }]
                ],
                resize_keyboard: true,
                one_time_keyboard: true,
            },
        };

        bot.sendMessage(chatId, requestLocationMessage, locationKeyboard);
    }
});

// Manzilni qabul qilish
bot.on('location', (msg) => {
    const chatId = msg.chat.id;
    const location = msg.location;

    if (location) {
        const channelId = '@mashinabozoruzzzz'; // Sizning kanal ID'ingizni kiriting

        // Yangi ariza ID'si
        const requestId = Date.now();
        userRequests[chatId] = userRequests[chatId] || [];
        userRequests[chatId].push({
            id: requestId,
            name: userNames[chatId],
            phone: userPhoneNumbers[chatId],
            location: { latitude: location.latitude, longitude: location.longitude },
            status: 'Active' // Yangi holat
        });

        // Kanalga foydalanuvchi ismi, telefon raqami va manzilini yuborish
        const locationMessage = userLanguages[chatId] === 'uz' ?
            `Yangi ariza qabul qilindi:\nID: ${requestId}\nIsm: ${userNames[chatId]}\nTelefon raqami: ${userPhoneNumbers[chatId]}\nManzil: ${location.latitude}, ${location.longitude}` :
            userLanguages[chatId] === 'ru' ?
            `–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞:\nID: ${requestId}\n–ò–º—è: ${userNames[chatId]}\n–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: ${userPhoneNumbers[chatId]}\n–ê–¥—Ä–µ—Å: ${location.latitude}, ${location.longitude}` :
            `New request received:\nID: ${requestId}\nName: ${userNames[chatId]}\nPhone number: ${userPhoneNumbers[chatId]}\nAddress: ${location.latitude}, ${location.longitude}`;

        bot.sendLocation(channelId, location.latitude, location.longitude).then(() => {
            bot.sendMessage(channelId, locationMessage);
        });

        bot.sendMessage(chatId, 'Ma\'lumotlaringiz qabul qilindi.');
        sendMainMenu(chatId, userLanguages[chatId]);
    }
});
